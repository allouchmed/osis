{% extends "layout.html" %}
{% load staticfiles %}
{% load i18n %}
{% load waffle_tags %}

{% comment "License" %}
* OSIS stands for Open Student Information System. It's an application
* designed to manage the core business of higher education institutions,
* such as universities, faculties, institutes and professional schools.
* The core business involves the administration of students, teachers,
* courses, programs and so on.
*
* Copyright (C) 2015-2019 Universit√© catholique de Louvain (http://www.uclouvain.be)
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* A copy of this license - GNU General Public License - is available
* at the root of the source code of this program.  If not,
* see http://www.gnu.org/licenses/.
{% endcomment %}

{% block breadcrumb %}
<li><a href="{% url 'catalog' %}" id="lnk_catalog">{% trans 'Formation catalogue'%}</a></li>
<li class="active" id="lnk_learning_units">{% trans 'Learning units' %}</li>
{% endblock %}

{% block content %}
{% if request.GET.academic_year_id and request.GET.academic_year_id != '0' %}
    {% url 'learning_unit_create' academic_year_id=request.GET.academic_year_id as create_learning_unit_url%}
    {% url 'proposal_learning_unit_creation_form' academic_year=request.GET.academic_year_id as create_proposal_url%}
    {% url 'learning_unit_create_external' academic_year=request.GET.academic_year_id as create_external_url%}
{% else %}
    {% url 'learning_unit_create' academic_year_id=current_academic_year.id as create_learning_unit_url%}
    {% url 'proposal_learning_unit_creation_form' academic_year=proposal_academic_year.id as create_proposal_url%}
    {% url 'learning_unit_create_external' academic_year=current_academic_year.id as create_external_url%}
{% endif %}

<div class="page-header">
    <div class="row">
        <div class="col-md-10">
            <h2>{% trans 'Learning units' %}</h2>
        </div>
        <div class="col-md-2" style="margin-top:20px;">
            <div class="btn-group pull-right">
                {% include "blocks/button/learning_units_action_button.html" %}
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" >
        <a href="{% url 'learning_units'%}" role="tab" id="lnk_activity_search">
            {% trans 'Learning unit'%}
        </a>
    </li>
    <li role="presentation" >
        <a href="{% url 'learning_units_service_course'%}" role="tab" id="lnk_service_course_search">
            {% trans 'Service courses'%}
        </a>
    </li>
    <li role="presentation" >
        <a href="{% url 'learning_units_borrowed_course'%}" role="tab" id="lnk_borrowed_course_search">
            {% trans 'Borrowed courses'%}
        </a>
    </li>
    <li role="presentation" class="active">
        <a href="{% url 'learning_units_proposal'%}" role="tab" id="lnk_proposal_search">
            {% trans 'Proposals'%}
        </a>
    </li>
    <li role="presentation" >
        <a href="{% url 'learning_units_external'%}" role="tab" id="lnk_external_search">
            {% trans 'External learning units'%}
        </a>
    </li>
    <li role="presentation" >
        <a href="{% url 'learning_units_summary' %}" role="tab" id="lnk_summary_list">
            {% trans 'Description fiche status' %}
        </a>
    </li>
</ul>
    {% include 'learning_unit/by_proposal.html' %}
{% endblock %}

{% block script %}
<script>
    $(document).ready(function()
    {
	 // Must be always DataTable declaration !!!
        setEventKeepIds('table_learning_units', 'learningUnitIds');
        let domTable = $('#table_learning_units');
        domTable.DataTable(
            {
                columnDefs: [
                    {
                        "name": "academic_year",
                        "targets": 0,
                        "data": "academic_year",
                        "render": function(data, type, row, meta){
                            let year = data;
                            let nextYear = data + 1;
                            return `${year}-${nextYear.toString().slice(2)}`;
                        }
                    },
                    {
                        "name": "acronym",
                        "targets": 1,
                        "data": "acronym",
                        "render": function ( data, type, row, meta ) {
                            return '<a href="'+ row['url'] +'">'+ data + '</a>';
                        }
                    },
                    {
                        "name": "title",
                        "targets": 2,
                        "data": "title",
                        "render": function(data, type, row, meta){
                            return data["fr"]
                        }
                    },
                    {"name": "type", "targets": 3,  "data": "type_text"},
                    {"name": "subtype", "targets": 4,  "data": "subtype_text"},
                    {"name": "requirement_entity", "targets": 5, "data": "requirement_entity"},
                    {"name": "allocation_entity", "targets": 6, "data": "allocation_entity"},
                    {"name": "credits", "targets": 7, "data": "credits"},
                    {
                        "name": "status",
                        "targets": 8,
                        "data": "status",
                        "render": function(data, type, row, meta){
                            if (data === true){
                                return "<span class=\"glyphicon glyphicon-ok-circle\" aria-hidden=\"true\" style=\"color: limegreen;\"\n" +
                                    "                                          title=\"{% trans 'Active' %}\"></span>\n" +
                                    "                                    <div style=\"display:none;\">1</div>"
                            }
                            return "<span class=\"glyphicon glyphicon-remove-circle\" aria-hidden=\"true\" style=\"color: red;\"\n" +
                                "                                          title=\"{% trans 'Inactive' %}\"></span>\n" +
                                "                                    <div style=\"display:none;\">0</div>"
                        }
                    },
                    {
                        "name": "has_proposal",
                        "targets": 9,
                        "data": "has_proposal",
                        "render": function(data, type, row, meta){
                            if (data === true){
                                return "<i class='fa fa-flag warning' data-toggle='tooltip' data-placement='right'" +
                                    " title='{% trans 'In proposal' %}''></i>"
                            }
                            return ""
                        }
                    }
                ],
                "stateSave": true,
                "paging" : false,
                "ordering" : true,
                "orderMulti": false,
                "serverSide": true,
                "ajax" : {
                    "url": "{% url 'learning_units' %}",
                    "type": "GET",
                    "dataSrc": "object_list",
                    "data": function (d){
                        let pageNumber = {{ page_obj.number }};
                        let paginator_size = {{ items_per_page }};
                        let querystring = getDataAjaxTable(domTable, d, pageNumber);
                        querystring["paginator_size"] = paginator_size;
                        return querystring;
                    },
                    "traditional": true
                },
                "info"  : false,
                "searching" : false,
                "language": {
                    "oAria": {
                        "sSortAscending":  "{% trans 'activate to sort column ascending'%}",
                        "sSortDescending": "{% trans 'activate to sort column descending'%}"
                    }
                }
            });

        // If needed could be generalized by giving the anchor a data-value-link attribute equal to the id of the input
        // that needs to be populated. Then extract this code to a file.
        $('.link_data_lookup').on("click", function(event){
            event.preventDefault();
            var link = $(this).prop("href");
            w = window.open(link, "id_tutor", 'height=500,width=800,resizable=yes,scrollbars=yes');
        });
    });

    $("#btn_produce_xls").click(function(e) {
        prepare_xls(e, 'xls');
    });

    $("#comparison_xls").click(function(e) {
        prepare_xls(e, 'xls_comparison');
        $("#comparison_year").val('');
    });

    $("#btn_xls_with_parameters").click(function(e) {
        prepare_xls(e, 'xls_with_parameters');
        $("#hdn_with_grp").val('');
        $("#hdn_with_attributions").val('');
    });

    function prepare_xls(e, action_value){
        e.preventDefault();
        var status = $("#xls_status");
        status.val(action_value);
        $("#download_xls").submit();
        status.val('');
    }

    $("#id_check_all").click(function(){
        $('input:checkbox.selected_object').not(this).prop('checked', this.checked);
    });

    $("#btn_produce_xls_proposal").click(function(e) {
        e.preventDefault();
        var status = $("#xls_status");
        status.val('xls');
        $("#proposals_form").submit();
        status.val('');
    });
    $("#btn_produce_xls_proposal_comparison").click(function(e) {
        e.preventDefault();
        var status = $("#xls_status");
        status.val('xls_comparison');
        $("#proposals_form").submit();
        status.val('');
    });
    $("#btn_produce_xls_detailled_attributions").click(function (e) {
        prepare_xls(e, 'xls_attributions');
    });
</script>
{% endblock %}
